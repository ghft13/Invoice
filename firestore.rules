rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated and matches ownerId
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isResourceOwner() {
      return request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    // Validation Helpers
    function isValidName(name) {
      // Must be string, 2-100 chars, matching allow-list regex (alphanumeric, spaces, .,-()/)
      // Firestore regex syntax is similar to standard regex but limited.
      // We block < and > to prevent HTML.
      return name is string 
             && name.size() >= 2 
             && name.size() <= 100
             && name.matches('^[a-zA-Z0-9\\s\\-\\.\\,\\(\\)\\/]+$');
    }
    
    function isValidGstin(gstin) {
      // Strict GSTIN regex: 2 digits, 5 uppercase chars, 4 digits, 1 uppercase char, 1 alphanumeric, Z, 1 alphanumeric
      return gstin == null || gstin == "" || (
        gstin is string 
        && gstin.size() == 15 
        && gstin.matches('^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$')
      );
    }

    function isValidInvoiceNumber(num) {
      // A-Z, 0-9, -, / only
      return num is string && num.size() > 0 && num.size() <= 20 && num.matches('^[A-Z0-9\\-\\/]+$');
    }

    function isValidAmount(amount) {
      return amount is number && amount >= 0 && amount != -0.0/0.0 && amount != 0.0/0.0; // No NaN/Infinity
    }

    // Users collection
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Invoices collection
    // Note: 'items' array validation is hard in rules. We rely on frontend + basic type checks here if possible.
    // Deep object validation in array is expensive in rules. We focus on root fields.
    match /invoices/{invoiceId} {
        allow create: if request.auth != null 
          && request.resource.data.ownerId == request.auth.uid
          && (request.resource.data.seller.name is string ? isValidName(request.resource.data.seller.name) : true) 
          // Validate logic: if name is present, it must be valid.
          && isValidInvoiceNumber(request.resource.data.invoiceNumber);

        allow read, delete: if isResourceOwner();
        allow update: if isResourceOwner()
          && isValidInvoiceNumber(request.resource.data.invoiceNumber);
    }

    // Clients collection
    match /clients/{clientId} {
      allow create: if request.auth != null 
        && request.resource.data.ownerId == request.auth.uid
        && isValidName(request.resource.data.name)
        && isValidGstin(request.resource.data.gstin);
        
      allow update: if isResourceOwner()
        && isValidName(request.resource.data.name)
        && isValidGstin(request.resource.data.gstin);
        
      allow read, delete: if isResourceOwner();
    }

    // Items collection
    match /items/{itemId} {
      allow create: if request.auth != null 
        && request.resource.data.ownerId == request.auth.uid
        && isValidName(request.resource.data.name)
        && isValidAmount(request.resource.data.price);
        
      allow update: if isResourceOwner()
        && isValidName(request.resource.data.name)
        && isValidAmount(request.resource.data.price);
        
      allow read, delete: if isResourceOwner();
    }
  }
}
